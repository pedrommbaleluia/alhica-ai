#!/bin/bash
#
# Script de Download Otimizado - Apenas Modelo Qwen-Automacao
# Vers√£o: 3.2.0 Single-Model Optimized
# Data: Janeiro 2025
# Configura√ß√£o: Qwen3-235B-Thinking (Automa√ß√£o) APENAS
# Redu√ß√£o: ~1.4TB de armazenamento (apenas 470GB necess√°rios)
#

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configura√ß√µes
INSTALL_DIR="/opt/alhica-ai"
MODELS_DIR="${INSTALL_DIR}/models"
VENV_DIR="${INSTALL_DIR}/venv"
LOG_DIR="${INSTALL_DIR}/logs"
LOG_FILE="${LOG_DIR}/download_automation_model.log"

# Configura√ß√£o do modelo √∫nico
MODEL_NAME="automation"
MODEL_DISPLAY_NAME="Qwen3-235B-Thinking (Automa√ß√£o)"
MODEL_HF_NAME="Qwen/Qwen3-235B-A22B-Thinking-2507"
MODEL_LOCAL_DIR="${MODELS_DIR}/qwen-automacao"
EXPECTED_FILES=118
EXPECTED_SIZE="470GB"

# Fun√ß√£o para log
log() {
    echo -e "${2:-$BLUE}[$(date +'%Y-%m-%d %H:%M:%S')] $1${NC}"
    mkdir -p "$(dirname "$LOG_FILE")"
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

# Fun√ß√£o para verificar se √© root
check_root() {
    if [ "$EUID" -ne 0 ]; then
        log "‚ùå Este script precisa ser executado como root" "$RED"
        exit 1
    fi
}

# Fun√ß√£o para verificar conectividade
check_connectivity() {
    log "üåê Verificando conectividade..." "$BLUE"
    
    # Testar conectividade geral
    if ! ping -c 3 8.8.8.8 &> /dev/null; then
        log "‚ùå Sem conectividade √† internet" "$RED"
        return 1
    fi
    
    # Testar Hugging Face Hub
    if ! curl -s --connect-timeout 10 https://huggingface.co &> /dev/null; then
        log "‚ùå N√£o √© poss√≠vel conectar ao Hugging Face Hub" "$RED"
        return 1
    fi
    
    log "‚úÖ Conectividade verificada" "$GREEN"
    return 0
}

# Fun√ß√£o para verificar espa√ßo em disco
check_disk_space() {
    log "üíæ Verificando espa√ßo em disco..." "$BLUE"
    
    # Verificar diret√≥rio de destino ou pai
    local check_dir="$MODELS_DIR"
    if [ ! -d "$check_dir" ]; then
        check_dir="$(dirname "$MODELS_DIR")"
        if [ ! -d "$check_dir" ]; then
            check_dir="/"
        fi
    fi
    
    local available_space=$(df "$check_dir" | tail -1 | awk '{print $4}')
    local available_gb=$((available_space / 1024 / 1024))
    local required_gb=500  # 470GB + margem de seguran√ßa
    
    log "üìä Espa√ßo dispon√≠vel: ${available_gb}GB" "$BLUE"
    log "üìä Espa√ßo necess√°rio: ${required_gb}GB" "$BLUE"
    
    if [ "$available_gb" -lt "$required_gb" ]; then
        log "‚ùå Espa√ßo insuficiente. Necess√°rio: ${required_gb}GB, Dispon√≠vel: ${available_gb}GB" "$RED"
        exit 1
    fi
    
    log "‚úÖ Espa√ßo em disco suficiente" "$GREEN"
}

# Fun√ß√£o para configurar vari√°veis de ambiente
setup_environment() {
    log "üîß Configurando vari√°veis de ambiente..." "$BLUE"
    
    # Configura√ß√µes para otimiza√ß√£o
    export HF_HUB_CACHE="${MODELS_DIR}/.cache"
    export TRANSFORMERS_CACHE="${MODELS_DIR}/.cache"
    export HF_HOME="${MODELS_DIR}/.cache"
    
    # Configura√ß√µes de rede
    export HF_HUB_ENABLE_HF_TRANSFER=0  # Desabilitar por compatibilidade
    export CURL_CA_BUNDLE=""
    export REQUESTS_CA_BUNDLE=""
    
    # Timeouts
    export HF_HUB_DOWNLOAD_TIMEOUT=3600  # 1 hora por arquivo
    
    log "‚úÖ Vari√°veis de ambiente configuradas" "$GREEN"
}

# Fun√ß√£o para criar infraestrutura b√°sica
create_basic_infrastructure() {
    log "üèóÔ∏è Criando infraestrutura b√°sica..." "$BLUE"
    
    # Criar diret√≥rios
    mkdir -p "$INSTALL_DIR"
    mkdir -p "$MODELS_DIR"
    mkdir -p "$LOG_DIR"
    mkdir -p "${MODELS_DIR}/.cache"
    
    # Instalar depend√™ncias b√°sicas se necess√°rio
    if ! command -v python3 &> /dev/null; then
        log "üì¶ Instalando Python3..." "$BLUE"
        apt update
        apt install -y python3 python3-pip python3-venv
    fi
    
    # Criar ambiente virtual se n√£o existir
    if [ ! -d "$VENV_DIR" ]; then
        log "üêç Criando ambiente virtual..." "$BLUE"
        python3 -m venv "$VENV_DIR"
    fi
    
    log "‚úÖ Infraestrutura b√°sica criada" "$GREEN"
}

# Fun√ß√£o para configurar ambiente Python
setup_python_environment() {
    log "üêç Configurando ambiente Python..." "$BLUE"
    
    # Verificar se ambiente virtual existe
    if [ ! -d "$VENV_DIR" ]; then
        log "üèóÔ∏è Ambiente virtual n√£o encontrado - criando infraestrutura..." "$YELLOW"
        create_basic_infrastructure
    fi
    
    # Ativar ambiente virtual
    source "${VENV_DIR}/bin/activate"
    
    # Atualizar pip
    pip install --upgrade pip setuptools wheel
    
    # Instalar depend√™ncias essenciais
    log "üì¶ Instalando depend√™ncias Python essenciais..." "$BLUE"
    
    # Instalar transformers e depend√™ncias
    pip install transformers huggingface-hub accelerate torch
    
    # Tentar instalar hf_transfer (opcional)
    log "üì¶ Tentando instalar hf_transfer (opcional)..." "$YELLOW"
    if pip install hf_transfer; then
        log "‚úÖ hf_transfer instalado - downloads ser√£o mais r√°pidos!" "$GREEN"
        export HF_HUB_ENABLE_HF_TRANSFER=1
    else
        log "‚ö†Ô∏è hf_transfer n√£o dispon√≠vel - usando m√©todo padr√£o" "$YELLOW"
        export HF_HUB_ENABLE_HF_TRANSFER=0
    fi
    
    log "‚úÖ Ambiente Python configurado" "$GREEN"
}

# Fun√ß√£o para verificar integridade do modelo
check_model_integrity() {
    local model_dir="$1"
    local expected_files="$2"
    
    if [ ! -d "$model_dir" ]; then
        return 1
    fi
    
    # Verificar arquivos essenciais
    if [ ! -f "${model_dir}/config.json" ]; then
        return 1
    fi
    
    # Contar arquivos .safetensors
    local safetensors_count=$(find "$model_dir" -name "*.safetensors" 2>/dev/null | wc -l)
    
    if [ "$safetensors_count" -ge "$expected_files" ]; then
        return 0
    else
        return 1
    fi
}

# Fun√ß√£o para download robusto do modelo
robust_download() {
    local model_name="$1"
    local model_hf_name="$2"
    local model_dir="$3"
    local expected_files="$4"
    local max_retries=5
    
    log "üéØ Processando modelo: $model_name ($model_hf_name)" "$CYAN"
    
    # Verificar se modelo j√° existe e est√° completo
    if check_model_integrity "$model_dir" "$expected_files"; then
        local existing_files=$(find "$model_dir" -name "*.safetensors" 2>/dev/null | wc -l)
        log "‚úÖ Modelo $model_name j√° existe e est√° completo ($existing_files ficheiros)" "$GREEN"
        return 0
    fi
    
    # Criar diret√≥rio do modelo
    mkdir -p "$model_dir"
    
    # Tentar download com retry
    for attempt in $(seq 1 $max_retries); do
        log "üì• Baixando $model_name (tentativa $attempt)..." "$BLUE"
        log "ü§ñ Baixando modelo $model_name: $model_hf_name..." "$BLUE"
        log "üìç Destino: $model_dir" "$BLUE"
        
        # Verificar conectividade antes de cada tentativa
        if ! check_connectivity; then
            log "‚ö†Ô∏è Problema de conectividade. Aguardando 30 segundos..." "$YELLOW"
            sleep 30
            continue
        fi
        
        # M√©todo 1: Tentar com huggingface-cli (mais robusto)
        if command -v huggingface-cli &> /dev/null; then
            log "üì• Tentando com huggingface-cli..." "$BLUE"
            
            if timeout 3600 huggingface-cli download \
                "$model_hf_name" \
                --local-dir "$model_dir" \
                --resume-download \
                --local-dir-use-symlinks False; then
                
                log "‚úÖ Download conclu√≠do com huggingface-cli!" "$GREEN"
                
                # Verificar integridade
                if check_model_integrity "$model_dir" "$expected_files"; then
                    log "‚úÖ Modelo $model_name verificado e completo" "$GREEN"
                    return 0
                else
                    log "‚ö†Ô∏è Modelo incompleto, tentando novamente..." "$YELLOW"
                    continue
                fi
            else
                log "‚ùå Falha com huggingface-cli (c√≥digo: $?)" "$RED"
            fi
        fi
        
        # M√©todo 2: Fallback para Python
        log "üîÑ Tentando com Python..." "$BLUE"
        
        # Ativar ambiente virtual
        source "${VENV_DIR}/bin/activate"
        
        if timeout 3600 python -c "
import os
from transformers import AutoTokenizer, AutoModelForCausalLM
from huggingface_hub import snapshot_download

try:
    print('üì• Baixando tokenizer...')
    tokenizer = AutoTokenizer.from_pretrained(
        '$model_hf_name',
        cache_dir='$model_dir',
        local_files_only=False,
        resume_download=True
    )
    tokenizer.save_pretrained('$model_dir')
    print('‚úÖ Tokenizer baixado')
    
    print('üì• Baixando modelo...')
    snapshot_download(
        repo_id='$model_hf_name',
        local_dir='$model_dir',
        resume_download=True,
        local_files_only=False
    )
    print('‚úÖ Modelo baixado')
    
except Exception as e:
    print(f'‚ùå Erro: {e}')
    exit(1)
"; then
            log "‚úÖ Download conclu√≠do com Python!" "$GREEN"
            
            # Verificar integridade
            if check_model_integrity "$model_dir" "$expected_files"; then
                log "‚úÖ Modelo $model_name verificado e completo" "$GREEN"
                return 0
            else
                log "‚ö†Ô∏è Modelo incompleto, tentando novamente..." "$YELLOW"
                continue
            fi
        else
            log "‚ùå Erro no download (c√≥digo: $?)" "$RED"
        fi
        
        # Aguardar antes da pr√≥xima tentativa
        if [ $attempt -lt $max_retries ]; then
            local wait_time=$((attempt * 30))
            log "‚è≥ Aguardando ${wait_time}s antes da pr√≥xima tentativa..." "$YELLOW"
            sleep $wait_time
        fi
    done
    
    log "‚ùå Falha no download do modelo $model_name ap√≥s $max_retries tentativas" "$RED"
    return 1
}

# Fun√ß√£o para relat√≥rio final
generate_final_report() {
    log "üìã RELAT√ìRIO FINAL - MODELO √öNICO QWEN-AUTOMACAO" "$CYAN"
    log "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" "$CYAN"
    
    # Verificar modelo
    local status="‚ùå FALHOU"
    local files_count=0
    local size="0GB"
    
    if check_model_integrity "$MODEL_LOCAL_DIR" "$EXPECTED_FILES"; then
        status="‚úÖ COMPLETO"
        files_count=$(find "$MODEL_LOCAL_DIR" -name "*.safetensors" 2>/dev/null | wc -l)
        size=$(du -sh "$MODEL_LOCAL_DIR" 2>/dev/null | cut -f1 || echo "N/A")
    fi
    
    log "ü§ñ AUTOMATION (Qwen3-235B-Thinking): $status" "$CYAN"
    log "üìä Ficheiros .safetensors: $files_count/$EXPECTED_FILES" "$BLUE"
    log "üíæ Tamanho: $size" "$BLUE"
    
    log "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" "$CYAN"
    
    if [ "$status" = "‚úÖ COMPLETO" ]; then
        log "üéâ MODELO BAIXADO COM SUCESSO!" "$GREEN"
        log "üíæ Espa√ßo total usado: $size" "$GREEN"
        log "üöÄ Pode prosseguir com a instala√ß√£o da Alhica AI!" "$GREEN"
        log "üìã Pr√≥ximo passo: ./install-alhica-infrastructure-single-model.sh" "$BLUE"
        return 0
    else
        log "‚ùå DOWNLOAD INCOMPLETO" "$RED"
        log "üîÑ Execute novamente este script para continuar" "$YELLOW"
        return 1
    fi
}

# Fun√ß√£o principal
main() {
    log "üöÄ Script de Download Otimizado - Modelo √önico Qwen-Automacao" "$CYAN"
    log "üìã Configura√ß√£o: Qwen3-235B-Thinking (Automa√ß√£o) APENAS" "$CYAN"
    log "üíæ Redu√ß√£o de armazenamento: ~1.4TB economizados (apenas 470GB necess√°rios)" "$CYAN"
    log "‚ö° Tempo estimado: 4-6 horas (vs 12-18 horas para 3 modelos)" "$CYAN"
    
    # Verifica√ß√µes iniciais
    check_root
    check_connectivity
    check_disk_space
    setup_environment
    setup_python_environment
    
    # Download do modelo √∫nico
    log "üéØ Iniciando download do modelo Qwen-Automacao..." "$CYAN"
    
    if robust_download "$MODEL_NAME" "$MODEL_HF_NAME" "$MODEL_LOCAL_DIR" "$EXPECTED_FILES"; then
        log "‚úÖ Download do modelo conclu√≠do com sucesso!" "$GREEN"
    else
        log "‚ùå Falha no download do modelo" "$RED"
        exit 1
    fi
    
    # Relat√≥rio final
    generate_final_report
}

# Executar fun√ß√£o principal
main "$@"

